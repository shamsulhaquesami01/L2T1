-- Write a PL/SQL function named EMPLOYEE_BONUS_ELIGIBILITY that takes an EMPLOYEE_ID as input and returns a VARCHAR2.
-- Return:

-- 'ELIGIBLE - FULL BONUS' if the employee:

-- Has worked for more than 3 years
-- Has salary below the average salary of their department
-- Has no subordinates


-- 'ELIGIBLE - PARTIAL BONUS' if the employee meets only 2 of the 3 conditions above
-- 'NOT ELIGIBLE' otherwise

-- Call the function for every employee and print the result. Handle exceptions appropriately.


CREATE OR REPLACE FUNCTION EMP_BONUS_ELIGIBILTY(eid IN NUMBER) RETURN VARCHAR2 IS
COUNTER NUMBER;
JOB_TIME NUMBER;
avg_salary NUMBER;
SAL NUMBER;
DEPT NUMBER;
SUB NUMBER;
BEGIN
    COUNTER:=0;
    SELECT (MONTHS_BETWEEN(E.HIRE_DATE,SYSDATE)/12) INTO JOB_TIME FROM EMPLOYEES E WHERE E.EMPLOYEE_ID=EID;
    IF(JOB_TIME>3) THEN COUNTER := COUNTER+1;
    END IF;
    SELECT E.DEPARTMENT_ID INTO DEPT FROM EMPLOYEES E WHERE E.EMPLOYEE_ID=EID;
    SELECT AVG(E.SALARY) INTO avg_salary FROM EMPLOYEES E WHERE E.DEPARTMENT_ID=DEPT;
     SELECT E.SALARY INTO SAL FROM EMPLOYEES E WHERE E.EMPLOYEE_ID=EID;
    IF(SAL<avg_salary) THEN COUNTER := COUNTER+1;
    END IF;
     SELECT COUNT(*) INTO SUB FROM EMPLOYEES E WHERE E.MANAGER_ID=EID;
     IF(SUB=0) THEN COUNTER:=COUNTER+1;
     END IF;
     IF(COUNTER=3) THEN RETURN 'ELIGIBLE-FULL';
    ELSIF(COUNTER=2) THEN RETURN 'ELIGIBLE-HALF';
    ELSE RETURN 'NOT-ELG';
    END IF;
END;
/


DECLARE
message varchar2(100);
begin
FOR R IN (SELECT EMPLOYEE_ID FROM EMPLOYEES)
LOOP
message:=EMP_BONUS_ELIGIBILTY(R.EMPLOYEE_ID);
DBMS_OUTPUT.PUT_LINE(message);
END LOOP;
end;


CREATE OR REPLACE FUNCTION DEPARTMENT_HEALTH_SCORE(DEPTID IN NUMBER) RETURN NUMBER IS
M_SAL NUMBER;
A_SAL NUMBER;
CNT NUMBER;
SCORE NUMBER;
CM NUMBER;
BEGIN
    SELECT MAX(SALARY) INTO M_SAL FROM EMPLOYEES WHERE DEPARTMENT_ID=DEPTID;
     IF M_SAL IS NULL THEN RETURN 0;
    END IF;
    SELECT AVG(SALARY) INTO A_SAL FROM EMPLOYEES WHERE DEPARTMENT_ID=DEPTID;
    SELECT COUNT(*) INTO CNT FROM EMPLOYEES WHERE MONTHS_BETWEEN(SYSDATE,HIRE_DATE)>60 AND DEPARTMENT_ID=DEPTID;
    SELECT COUNT(*) INTO CM FROM EMPLOYEES E WHERE E.SALARY <(
        SELECT J.min_salary FROM JOBS J WHERE E.JOB_ID=J.JOB_ID
    ) AND E.DEPARTMENT_ID=DEPTID;
    SCORE:=ROUND((A_SAL/M_SAL)*100 + CNT*5 - CM*10,2);
    RETURN SCORE;
    EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('Department ' || DEPTID || ' not found.');
        RETURN NULL;
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
        RETURN NULL;
END;
/
CREATE TABLE HEALTH(
    DNAME VARCHAR2(100),
    DID NUMBER,
    SCORE NUMBER
);

DECLARE
message NUMBER;
begin
FOR R IN (SELECT DEPARTMENT_ID,DEPARTMENT_NAME FROM DEPARTMENTS)
LOOP
message:=DEPARTMENT_HEALTH_SCORE(R.DEPARTMENT_ID);
INSERT INTO HEALTH VALUES(R.DEPARTMENT_NAME,R.DEPARTMENT_ID,MESSAGE);
END LOOP;

end;

SELECT DNAME,DID,SCORE FROM HEALTH ORDER BY SCORE DESC;

SELECT 
    ROWNUM AS RANK,
    DNAME,
    DID,
    SCORE
FROM (
    SELECT DNAME, DID, SCORE 
    FROM HEALTH 
    ORDER BY SCORE DESC
);


CREATE OR REPLACE PROCEDURE MANAGER_PERFROMANCE_REPORT IS

BEGIN
    FOR R IN (
        SELECT FIRST_NAME,DEPARTMENT_NAME,S_COUNT, A_S_SAL,J_MIN_SAL,
        RANK() OVER (ORDER BY  S_COUNT DESC,A_S_SAL DESC)  AS RNK FROM(
                SELECT E.FIRST_NAME, (SELECT DEPARTMENT_NAME FROM DEPARTMENTS WHERE DEPARTMENT_ID=E.DEPARTMENT_ID) AS DEPARTMENT_NAME, 
                (SELECT COUNT(*) FROM EMPLOYEES WHERE MANAGER_ID=E.EMPLOYEE_ID) AS S_COUNT,
                (SELECT AVG(SALARY) FROM EMPLOYEES WHERE MANAGER_ID=E.EMPLOYEE_ID) AS A_S_SAL,
                (SELECT COUNT(*) FROM EMPLOYEES E2 WHERE E2.SALARY < (
                    SELECT J.min_salary FROM JOBS J WHERE J.JOB_ID=E2.JOB_ID
                ) AND MANAGER_ID=E.EMPLOYEE_ID) AS J_MIN_SAL FROM EMPLOYEES E
               WHERE E.EMPLOYEE_ID IN (SELECT MANAGER_ID FROM EMPLOYEES WHERE MANAGER_ID IS NOT NULL)
        )
    )
    LOOP
    DBMS_OUTPUT.PUT_LINE(R.RNK||'   '||R.FIRST_NAME||'   '||R.DEPARTMENT_NAME||'   '||R.S_COUNT||'   '||R.A_S_SAL||'   '||R.J_MIN_SAL);
    END LOOP;
END;
/

EXECUTE MANAGER_PERFROMANCE_REPORT;


COMMIT;

CREATE TABLE PROMOTION_LOG (
    employee_id   NUMBER,
    old_salary    NUMBER,
    new_salary    NUMBER,
    change_type   VARCHAR2(20),  -- 'PROMOTION', 'DEMOTION', 'MINOR_CHANGE'
    log_date      DATE
);
DROP TABLE EMPLOYEES_COPY;
CREATE TABLE EMPLOYEES_COPY AS SELECT * FROM EMPLOYEES;
create OR REPLACE TRIGGER LOG_SALARY_UPDATE BEFORE UPDATE OF SALARY ON EMPLOYEES_COPY
FOR EACH ROW
DECLARE
S_COUNT NUMBER;
S_SAL NUMBER;
TEMP NUMBER;
M1 NUMBER;
BEGIN
    SELECT COUNT(*) INTO S_COUNT FROM EMPLOYEES WHERE MANAGER_ID=:OLD.EMPLOYEE_ID;
    SELECT E.EMPLOYEE_ID INTO S_SAL FROM EMPLOYEES E WHERE E.MANAGER_ID=:OLD.EMPLOYEE_ID AND E.SALARY> ALL(
        SELECT E2.SALARY FROM EMPLOYEES E2 WHERE E2.MANAGER_ID=E.MANAGER_ID AND E2.EMPLOYEE_ID <> E.EMPLOYEE_ID
    ) ;
    IF((:NEW.SALARY - :OLD.SALARY)/:OLD.SALARY >0.2) THEN INSERT INTO PROMOTION_LOG VALUES(:OLD.EMPLOYEE_ID,:OLD.SALARY,:NEW.SALARY,'PROMOTION',SYSDATE);
    ELSIF ((:OLD.SALARY - :NEW.SALARY)/:OLD.SALARY >0.15) THEN 
    INSERT INTO PROMOTION_LOG VALUES(:OLD.EMPLOYEE_ID,:OLD.SALARY,:NEW.SALARY,'DEMOTION',SYSDATE);
        IF(S_COUNT >0) THEN TEMP:= :OLD.MANAGER_ID; 
        SELECT E.MANAGER_ID INTO M1 FROM EMPLOYEES E WHERE E.EMPLOYEE_ID=S_SAL;
        UPDATE  EMPLOYEES SET MANAGER_ID = M1 WHERE EMPLOYEE_ID=:OLD.EMPLOYEE_ID;
        UPDATE  EMPLOYEES SET MANAGER_ID = TEMP WHERE EMPLOYEE_ID=S_SAL;
        END IF;
    ELSE INSERT INTO PROMOTION_LOG VALUES(:OLD.EMPLOYEE_ID,:OLD.SALARY,:NEW.SALARY,'MINOR',SYSDATE);
    END IF;

END;
/


CREATE TABLE DEPT_OVERFLOW_LOG (
    department_id   NUMBER,
    rejected_emp    VARCHAR2(100),
    reason          VARCHAR2(200),
    log_date        DATE
);

CREATE OR REPLACE TRIGGER CHECHK_DEPT_CAPACITY BEFORE INSERT  ON EMPLOYEES
 FOR EACH ROW 
DECLARE
CNT NUMBER;
min_sal number;
BEGIN
    SELECT COUNT(*) INTO CNT FROM EMPLOYEES WHERE DEPARTMENT_ID=:NEW.DEPARTMENT_ID;
    IF(CNT>10) THEN 
    INSERT INTO DEPT_OVERFLOW_LOG VALUES(:NEW.DEPARTMENT_ID,:NEW.EMPLOYEE_ID,'MORE EMPLOYEES',SYSDATE);
    RAISE_APPLICATION_ERROR(-20001, 'Department is full!');
    END IF;
    SELECT J.min_salary into min_sal FROM JOBS J WHERE J.JOB_ID=:NEW.JOB_ID;
    IF(:NEW.SALARY < min_sal) THEN 
    :NEW.SALARY := min_sal;
    END IF;
    IF(:NEW.MANAGER_ID IS NULL) THEN 
    SELECT MANAGER_ID INTO :NEW.MANAGER_ID
    FROM (
    SELECT MANAGER_ID, COUNT(*) AS CNT2
    FROM EMPLOYEES
    WHERE DEPARTMENT_ID = :NEW.DEPARTMENT_ID
    AND MANAGER_ID IS NOT NULL
    GROUP BY MANAGER_ID
    ORDER BY CNT2 ASC
    )
    WHERE ROWNUM = 1;
    END IF;
END;
/
